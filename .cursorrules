# Architecture SaaS - Syst√®me de Prise de Commande pour Bo√Ætes de Nuit

> üìñ Documentation compl√®te disponible dans `.cursor/rules/RULE.md`
> üìå User stories disponibles dans `.cursor/rules/USER_STORIES.md`

## Contexte
PWA Next.js 16+ pour digitaliser la prise de commande en bo√Æte de nuit. Architecture multi-tenant (SaaS) avec Clean Architecture/Hexagonale.

## Stack
- Next.js 16+ (App Router), TypeScript strict
- PostgreSQL + Redis
- Stripe / Mobile Money
- Socket.io/Pusher (temps r√©el)
- Docker + Docker Compose (VPS Ubuntu)

## Architecture (Clean Code)

```
/src
  /app                 # Presentation Layer (Next.js routes)
    /[tenantId]        # Multi-tenant routing
    /api               # API endpoints
  /core                # Domain Layer (logique m√©tier pure)
    /entities          # Order, Product, Tenant, Table
    /use-cases         # CreateOrder, UpdateStock, etc.
    /repositories      # Interfaces (IOrderRepository)
  /infrastructure      # Infrastructure Layer
    /database          # Prisma/TypeORM
    /payment           # Stripe/Mobile Money adapters
    /realtime          # WebSocket handlers
  /shared              # Utils, types
```

## R√®gles Critiques

### 1. Multi-tenancy (OBLIGATOIRE)
- **TOUJOURS** filtrer par `tenantId` dans les requ√™tes DB
- **JAMAIS** exposer des donn√©es d'un tenant √† un autre
- Middleware de validation `tenantId` sur toutes les routes API

### 2. Transactions & Concurrence
- Transactions DB pour op√©rations critiques (cr√©ation commande, stock)
- Syst√®me de "hold" pour √©viter doubles commandes
- V√©rifier stock **avant** ET **pendant** cr√©ation commande

### 3. Workflow Commande
1. Scan QR ‚Üí Identifie tenant + table
2. Affichage menu ‚Üí Filtre par `tenant_id` + `stock > 0`
3. Cr√©ation commande ‚Üí Transaction avec v√©rification stock
4. Paiement ‚Üí Webhook Stripe/Mobile Money
5. Notification temps r√©el ‚Üí WebSocket au barman (`tenant-bar` channel)
6. Service ‚Üí Statuts: PENDING_PAYMENT ‚Üí PAID ‚Üí PREPARING ‚Üí READY ‚Üí DELIVERED

### 4. Mod√®le de Donn√©es
- **Tenant** (club) : id, name, slug, logoUrl, settings
- **User** : id, role (ADMIN/BARTENDER/WAITER), email, tenantId
- **Product** : id, name, price, stockQuantity, isAvailable, tenantId
- **Table** : id, label, qrCodeUrl, tenantId
- **Order** : id, status, totalAmount, createdAt, tableId, tenantId
- **OrderItem** : id, quantity, unitPrice, orderId, productId

**‚ö†Ô∏è R√àGLE CRITIQUE** : Tenant est partout. Toute requ√™te doit filtrer par `tenantId`.

### 5. Conventions Code
- Entit√©s : PascalCase (`Order`, `Product`)
- Use Cases : PascalCase verbe (`CreateOrder`)
- Repositories : Interface `I` (`IOrderRepository`)
- Routes API : kebab-case (`/api/orders/create-order`)

### 6. S√©curit√©
- Validation entr√©es (Zod recommand√©)
- JWT pour auth
- R√¥les/permissions (ADMIN, BARTENDER, WAITER)
- Chiffrement donn√©es sensibles

### 7. Performance
- Redis cache pour menus
- Pagination listes
- Index DB sur `tenant_id`, `table_id`, `status`
- Next.js ISR pour pages publiques

## Exemple Use Case

```typescript
// /core/use-cases/CreateOrder.ts
export class CreateOrder {
  constructor(
    private orderRepository: IOrderRepository,
    private productRepository: IProductRepository
  ) {}

  async execute(tenantId: string, tableId: string, items: OrderItem[]): Promise<Order> {
    // 1. Valider stock (avec tenantId)
    // 2. R√©server stock (transaction)
    // 3. Cr√©er Order (statut PENDING_PAYMENT)
    // 4. Retourner Order
  }
}
```

## Exemple API Route

```typescript
// /app/api/[tenantId]/orders/route.ts
export async function POST(
  request: Request,
  { params }: { params: { tenantId: string } }
) {
  // 1. Valider tenantId (middleware)
  // 2. Parser body (Zod)
  // 3. Appeler use case CreateOrder
  // 4. Retourner r√©ponse
}
```

## √âvolutivit√©
- Phase 1 (MVP) : Un tenant, Stripe, WebSockets basiques
- Phase 2 (SaaS) : Multi-tenant, dashboard admin, analytics
- Phase 3 (Scale) : Kubernetes, RDS, CDN, monitoring

## Outils Recommand√©s
- **ORM** : Prisma
- **Validation** : Zod
- **UI** : Tailwind CSS + shadcn/ui (d√©j√† configur√©)
- **Tests** : Vitest (unit), Playwright (E2E)
